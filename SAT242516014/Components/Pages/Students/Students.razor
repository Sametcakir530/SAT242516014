@page "/students"

@attribute [Authorize(Roles = "Admin,User")]

@using System.Reflection
@using Microsoft.AspNetCore.Authorization
@using Microsoft.Extensions.Localization
@using System.Text.Json
@using MyDbModels
@using Attributes
@using MyEnums
@using Extensions
@using Providers
@using SAT242516014.Filtering
@using SAT242516014.Components
@using E = SAT242516014.Filtering.Student
@using SAT242516014.Models.MyEnums

@inject IMyDbModel<E> _myDbModel
@inject IMyDbModel_Provider _myDbModel_Provider
@inject IJSRuntime JS
@inject ILogger<E> Logger
@inject LocalizerService<MyResource> _localizer

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="text-danger m-0">
        @_localizer["Students"]
    </h1>

    <button class="btn btn-primary" @onclick="OpenStats">
        <i class="fas fa-chart-bar"></i> Grafik
    </button>
</div>

<hr />

@if (_myDbModel != null)
{

    @if (new[] { Operations.Add, Operations.Update, Operations.Remove, Operations.Detail }.Contains(_operation))
    {
        <div class="card mb-3">
            <div class="card-header">
                <h1 class="fw-bolder text-@_operation.Color()">@(_operation.Description())</h1>
            </div>
            <div class="card-body">
                @foreach (var prop in GetProperties().Where(p => p.Name != "Id" && p.Name != "DoğumTarihi"))
                {
                    @if (_operation != Operations.Detail && prop.Editable())
                    {
                        <div class="input-group mb-2">
                            <div class="input-group-text w-25 fw-bolder">@prop.LocalizedDescription()</div>
                            <input type="text" class="form-control" placeholder="@prop.Name"
                                   value="@(prop.GetValue(_model, null))"
                                   @onchange="(ChangeEventArgs e) => OnChange_EditInput(prop.Name, e.Value)" />
                        </div>
                    }
                    else
                    {
                        <div class="row g-2 mb-2">
                            <div class="col-md-3 fw-bolder">@prop.LocalizedDescription()</div>
                            <div class="col-md-9">@prop.GetValue(_model, null)</div>
                        </div>
                    }
                }

                <div class="btn-group">
                    @if (_operation != Operations.Detail)
                    {
                        <button class="btn btn-@_operation.Color()" @onclick="() => OnClick_Save()">
                            @_operation.Description()
                        </button>
                    }
                    <button class="btn btn-outline-@Operations.Cancel.Color()" @onclick="() => OnClick_Cancel()">
                        @Operations.Cancel.Description()
                    </button>
                </div>
            </div>
        </div>
    }

    @if (_operation == Operations.List)
    {
        <h1 class="text-@(Operations.List.Color())">
            @(Operations.List.Description())
        </h1>

        <div class="row g-2 mb-3">
            <div class="col-md-2">
                <input class="form-control text-center fw-bold" readonly
                       value="@(TotalRecordCount == 0 ? "0 - 0 / (0)" : $"{(PageNumber - 1) * PageSize + 1} - {Math.Min(TotalRecordCount, PageNumber * PageSize)} / ({TotalRecordCount})")" />
            </div>

            <div class="col-md-2">
                <select class="form-select" value="@OrderBy" @onchange="e => OnChange_OrderBy(e.Value)">
                    @foreach (var item in _sortingOptions)
                    {
                        <option value="@item.Key">@item.Value</option>
                    }
                </select>
            </div>

            <div class="col-md-1">
                <select class="form-select" value="@PageSize" @onchange="e => OnChange_PageSize(e.Value)">
                    @foreach (var ps in new[] { 5, 10, 20, 50, 100, int.MaxValue })
                    {
                        <option value="@ps">@((ps == int.MaxValue ? "∞" : ps.ToString()))</option>
                    }
                </select>
            </div>

            <div class="col-md-6">
                @if (TotalRecordCount > 0 && TotalPageCount > 1)
                {
                    <ul class="pagination">
                        <li class="page-item @(PageNumber == 1 ? "disabled" : "")"><button class="page-link" @onclick="PrevPage">@("<")</button></li>
                        @for (var pn = Math.Max(1, PageNumber - 2); pn <= Math.Min(TotalPageCount, PageNumber + 2); pn++)
                        {
                            var pnx = pn;
                            <li class="page-item @(pnx == PageNumber ? "active" : "")">
                                <button class="page-link" @onclick="() => GoToPage(pnx)">@pnx</button>
                            </li>
                        }
                        <li class="page-item @(PageNumber == TotalPageCount ? "disabled" : "")"><button class="page-link" @onclick="NextPage">@(">")</button></li>
                    </ul>
                }
            </div>
        </div>

        <table class="table table-striped">
            <thead>
                <tr>
                    <th>
                        <button class="btn btn-outline-@(Operations.Add.Color())" @onclick="() => OnClick_Operation(Operations.Add)">
                            @(Operations.Add.Description())
                        </button>
                    </th>
                    @foreach (var prop in GetProperties().Where(p => p.Name != "DoğumTarihi"))
                    {
                        <th>@prop.LocalizedDescription()</th>
                    }
                </tr>
                <tr>
                    <th>
                        <button class="btn btn-outline-@Operations.Reset.Color()" @onclick="() => OnChange_Filter_Reset()">
                            @(Operations.Reset.Description())
                        </button>
                    </th>
                    @foreach (var prop in GetProperties().Where(p => p.Name != "DoğumTarihi"))
                    {
                        <th>
                            <input type="text" class="form-control text-center"
                                   placeholder="@prop.LocalizedDescription()"
                                   value="@Parameter_GetValue(prop.Name)"
                                   @onchange="(ChangeEventArgs e) => OnChange_Filter(prop.Name, e.Value)" />
                        </th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var item in _myDbModel.Items)
                {
                    <tr>
                        <td>
                            <div class="btn-group">
                                @foreach (var op in new[] { Operations.Detail, Operations.Update, Operations.Remove })
                                {
                                    <button class="btn btn-sm btn-outline-@op.Color()" @onclick="() => OnClick_Operation(op, item.Id)">
                                        @(op.Description())
                                    </button>
                                }
                            </div>
                        </td>
                        @foreach (var prop in GetProperties().Where(p => p.Name != "DoğumTarihi"))
                        {
                            <td>@(prop.GetValue(item, null))</td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    }
}

@* --- GRAFİK MODALI --- *@
@if (_showStatsModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Öğrenci İstatistikleri</h5>
                    <button type="button" class="btn-close" @onclick="CloseStats"></button>
                </div>
                <div class="modal-body">
                    <StudentStats />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseStats">Kapat</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    string _spName_List = "sp_Students";
    string _spName_Add_Update_Remove = "sp_Student_Add_Update_Remove";

    E _model = new();
    bool _showStatsModal = false;
    Operations _operation = Operations.List;

    private Dictionary<string, string> _sortingOptions = new()
    {
        { "Id asc", "Id Artan" },
        { "Id desc", "Id Azalan" },
        { "Ad asc", "Ad (A-Z)" },
        { "Ad desc", "Ad (Z-A)" }
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _myDbModel.Parameters.OrderBy = "Id asc";
            if (_myDbModel.Parameters.PageNumber <= 0) _myDbModel.Parameters.PageNumber = 1;
            await GetItemsAsync();
        }
    }

    async Task GetItemsAsync()
    {
        _operation = Operations.List;
        await _myDbModel_Provider.Execute<E>(_myDbModel, _spName_List);
        StateHasChanged();
    }

    private async void GetItems() => await GetItemsAsync();

    void OpenStats() => _showStatsModal = true;
    void CloseStats() => _showStatsModal = false;

    private string? Parameter_GetValue(string name) => _myDbModel.Parameters.Where.ContainsKey(name) ? _myDbModel.Parameters.Where[name] : null;

    void OnChange_Filter(string columnName, object value)
    {
        var valStr = value?.ToString();
        if (string.IsNullOrEmpty(valStr)) _myDbModel.Parameters.Where.Remove(columnName);
        else _myDbModel.Parameters.Where[columnName] = valStr;
        GetItems();
    }

    void OnChange_Filter_Reset()
    {
        _myDbModel.Parameters.Where.Clear();
        GetItems();
    }

    private int TotalRecordCount => _myDbModel.Parameters.TotalRecordCount;
    private int TotalPageCount => _myDbModel.Parameters.TotalPageCount;
    public string OrderBy { get => _myDbModel.Parameters.OrderBy; set { _myDbModel.Parameters.OrderBy = value; GetItems(); } }
    private int PageSize { get => _myDbModel.Parameters.PageSize; set { _myDbModel.Parameters.PageSize = value; GetItems(); } }
    private int PageNumber { get => _myDbModel.Parameters.PageNumber; set { _myDbModel.Parameters.PageNumber = value; GetItems(); } }

    void OnChange_OrderBy(object value) { _myDbModel.Parameters.OrderBy = value?.ToString() ?? "Id asc"; GetItems(); }
    void OnChange_PageSize(object value) { int.TryParse(value?.ToString(), out var ps); _myDbModel.Parameters.PageSize = ps; GetItems(); }
    void OnChange_PageNumber(object value) { int.TryParse(value?.ToString(), out var pn); _myDbModel.Parameters.PageNumber = pn; GetItems(); }

    void PrevPage() { if (PageNumber > 1) PageNumber--; }
    void NextPage() { if (PageNumber < TotalPageCount) PageNumber++; }
    void GoToPage(int page) { if (page >= 1 && page <= TotalPageCount) PageNumber = page; }

    private void OnClick_Operation(Operations operation, int? id = 0)
    {
        _operation = operation;
        _model = operation == Operations.Add ? new E() : _myDbModel.Items.FirstOrDefault(f => f.Id == id) ?? new E();
    }

    private async void OnClick_Save()
    {
        var jsonvalues = JsonSerializer.Serialize(_model);
        var results = await _myDbModel_Provider.SetItems<MyDbModel_Result_KeyValue<string, bool>>(_spName_Add_Update_Remove
            , (Key: "operation", Value: (object)_operation.ToString().ToLower())
            , (Key: "jsonvalues", Value: (object)jsonvalues));

        var result = results.FirstOrDefault();
        if (result != null) await JS.InvokeVoidAsync("alert", $"{result.Key} : {result.Value}");
        await GetItemsAsync();
    }

    private void OnClick_Cancel() => _operation = Operations.List;

    private void OnChange_EditInput(string name, object value)
    {
        var prop = typeof(E).GetProperty(name);
        if (prop != null)
        {
            var targetType = Nullable.GetUnderlyingType(prop.PropertyType) ?? prop.PropertyType;
            object safeValue = (value == null || string.IsNullOrEmpty(value.ToString())) ? null : Convert.ChangeType(value, targetType);
            prop.SetValue(_model, safeValue);
        }
    }

    private IEnumerable<PropertyInfo> GetProperties() => typeof(E).GetProperties().Where(p => p.GetIndexParameters().Length == 0);
}